<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kuromi æ’çƒæ•¸æ“šå¤§å¸« ğŸ˜ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #F3E8FF; color: #4C1D95; }
        .kuromi-card { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.4); border-radius: 2rem; }
        .glass-btn { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3); }
        .hidden { display: none; }
        input, select { background: rgba(255, 255, 255, 0.5); border: 1px solid #D8B4FE; border-radius: 0.75rem; padding: 0.5rem 1rem; outline: none; }
        .scroll-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <!-- 1. ç™»å…¥é é¢ -->
    <div id="page-login" class="min-h-screen flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-8">
            <h1 class="text-4xl font-black mb-2">KUROMI</h1>
            <p class="text-lg opacity-60">Volleyball Tracker ğŸ˜ˆ</p>
        </div>
        <button onclick="login()" class="kuromi-card px-8 py-4 font-bold shadow-xl flex items-center gap-3 active:scale-95 transition">
            <img src="https://www.google.com/favicon.ico" class="w-5 h-5">
            ä½¿ç”¨ Google ç™»å…¥ä¸¦åŒæ­¥æ•¸æ“š
        </button>
    </div>

    <!-- 2. åˆå§‹åŒ–é é¢ -->
    <div id="page-setup" class="hidden min-h-screen p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">æ–°æ¯”è³½è¨­å®š</h2>
            <button onclick="viewHistory()" class="text-sm underline opacity-50">æ­·å²ç´€éŒ„</button>
        </div>
        <div class="kuromi-card p-6 space-y-4 shadow-lg">
            <div>
                <label class="text-xs font-bold opacity-50 block mb-1">æ¯”è³½æ—¥æœŸ</label>
                <input type="date" id="setup-date" class="w-full">
            </div>
            <div>
                <label class="text-xs font-bold opacity-50 block mb-1">è³½äº‹ç¨®é¡</label>
                <select id="setup-type" class="w-full">
                    <option>ğŸ† è¯è³½</option><option>ğŸ“Š æ’ä½è³½</option><option>ğŸ–ï¸ éŒ¦æ¨™è³½</option><option>ğŸ æ™®é€šæ¯”è³½</option>
                </select>
            </div>
            <div>
                <label class="text-xs font-bold opacity-50 block mb-1">å°æ‰‹åç¨±</label>
                <input type="text" id="setup-opponent" placeholder="è¼¸å…¥å°æ‰‹çƒéšŠåå­—..." class="w-full">
            </div>
            <button onclick="startMatch()" class="w-full bg-[#8B5CF6] text-white py-4 rounded-2xl font-black text-lg shadow-lg active:scale-95 transition">é–‹å§‹è¨˜éŒ„æ¯”è³½!</button>
        </div>
    </div>

    <!-- 3. è¨ˆåˆ†è¿½è¹¤ä»‹é¢ -->
    <div id="page-tracker" class="hidden min-h-screen p-4 flex flex-col">
        <!-- é ‚éƒ¨è³‡è¨Š -->
        <div class="flex justify-between items-center mb-4 px-2">
            <div class="text-xs font-bold opacity-60">
                <span id="display-type"></span> | <span id="display-opponent"></span>
            </div>
            <button onclick="undo()" class="glass-btn px-4 py-1 rounded-full text-xs font-bold">â†© è¿”å› (Undo)</button>
        </div>

        <!-- æ¯”åˆ†æ¿ -->
        <div class="kuromi-card p-6 shadow-md text-center mb-6 relative">
            <div class="flex justify-around items-center">
                <div class="flex-1">
                    <p class="text-xs opacity-50">æˆ‘æ–¹</p>
                    <h1 id="score-a" class="text-6xl font-black text-[#8B5CF6]">0</h1>
                    <div id="sets-a" class="mt-2 text-sm font-black text-pink-400">Sets: 0</div>
                </div>
                <div class="text-3xl opacity-20 font-light">:</div>
                <div class="flex-1">
                    <p class="text-xs opacity-50 text-gray-400">å°æ‰‹</p>
                    <h1 id="score-b" class="text-6xl font-black opacity-30">0</h1>
                    <div id="sets-b" class="mt-2 text-sm font-black opacity-20">Sets: 0</div>
                </div>
            </div>
        </div>

        <!-- ç‹€æ…‹åˆ‡æ› -->
        <div class="flex justify-center mb-4">
            <button id="bench-toggle" onclick="toggleBench()" class="px-6 py-2 rounded-full font-bold shadow-sm transition-all text-sm bg-[#FFD1E8]">
                ğŸ˜ˆ ç”·å‹åœ¨å ´ä¸Š
            </button>
        </div>

        <!-- æ•¸æ“šæŒ‰éˆ•å€ -->
        <div id="on-court-actions" class="grid grid-cols-2 gap-3 mb-6 flex-grow overflow-y-auto scroll-hide">
            <!-- ç”± JS å‹•æ…‹ç”Ÿæˆæ®ºçƒã€æ””ç¶²ç­‰ -->
        </div>

        <!-- é€šç”¨æŒ‰éˆ•å€ (å¾Œå‚™æ™‚é¡¯ç¤º) -->
        <div id="bench-actions" class="hidden grid grid-cols-2 gap-3 mb-6">
            <button onclick="recordScore('A', 'éšŠå‹å¾—åˆ†', 1)" class="h-32 bg-purple-400 text-white rounded-[2rem] font-bold text-lg shadow-lg">æˆ‘æ–¹å¾—åˆ†</button>
            <button onclick="recordScore('B', 'å°æ‰‹å¾—åˆ†', 3)" class="h-32 bg-gray-400 text-white rounded-[2rem] font-bold text-lg shadow-lg">å°æ‰‹å¾—åˆ†</button>
        </div>

        <!-- å‚™è¨»æ¬„ -->
        <div class="mt-auto">
            <textarea id="match-memo" placeholder="è¼¸å…¥ç•¶å‰å‚™è¨» (ä¾‹å¦‚: ç”·å‹ä»Šå¤©æ””ç¶²è¶…å¼·...)" class="w-full p-4 rounded-2xl bg-white/40 text-sm h-16 outline-none"></textarea>
        </div>
    </div>

    <!-- 4. ç¢ºèªè·³çª— -->
    <div id="modal-confirm" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-white rounded-[2.5rem] p-8 w-full max-w-sm text-center shadow-2xl">
            <h2 class="text-2xl font-black mb-2">æœ¬å±€çµæŸï¼ŸğŸ˜ˆ</h2>
            <p id="modal-score" class="text-lg opacity-60 mb-8">25 : 23</p>
            <div class="flex flex-col gap-3">
                <button onclick="confirmSet()" class="py-4 bg-[#8B5CF6] text-white rounded-full font-bold shadow-lg">ç¢ºå®šçµç®—é€²å…¥ä¸‹ä¸€å±€</button>
                <button onclick="closeModal()" class="py-4 bg-gray-100 rounded-full font-bold text-gray-400">ä¸å°å¿ƒæŒ‰éŒ¯äº†</button>
            </div>
        </div>
    </div>

    <!-- 5. æ­·å²ç´€éŒ„é é¢ -->
    <div id="page-history" class="hidden min-h-screen p-6">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="showPage('setup')" class="text-2xl">â†</button>
            <h2 class="text-2xl font-bold">æ­·å²æ¯”è³½æ•¸æ“š</h2>
        </div>
        <div id="history-list" class="space-y-4 text-sm">
            <!-- æ­·å²æ¸…å–® -->
        </div>
    </div>

    <!-- FIREBASE & é‚è¼¯ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”¥ å¦³çš„ Firebase Config å·²ç¶“è¨­å®šå¥½äº†ï¼
        const firebaseConfig = {
          apiKey: "AIzaSyCg4RX71wE7Wus4wqt-Gwj4lTBNREg4kRo",
          authDomain: "mykuromivolley.firebaseapp.com",
          projectId: "mykuromivolley",
          storageBucket: "mykuromivolley.firebasestorage.app",
          messagingSenderId: "739236472230",
          appId: "1:739236472230:web:30e594b0b641e491245b67"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let matchData = {
            scoreA: 0, scoreB: 0, setsA: 0, setsB: 0,
            isBench: false, logs: [],
            info: { date: "", type: "", opponent: "" }
        };
        let historyStack = [];

        // ç™»å…¥åŠŸèƒ½
        window.login = async () => {
            try {
                const res = await signInWithPopup(auth, provider);
                currentUser = res.user;
                showPage('setup');
            } catch (e) { alert("ç™»å…¥å¤±æ•—: " + e.message); }
        };

        // é¡¯ç¤ºé é¢
        window.showPage = (pageId) => {
            ['login', 'setup', 'tracker', 'history'].forEach(p => {
                document.getElementById('page-' + p).classList.add('hidden');
            });
            document.getElementById('page-' + pageId).classList.remove('hidden');
        };

        // åˆå§‹åŒ–
        window.startMatch = () => {
            const opp = document.getElementById('setup-opponent').value;
            if (!opp) return alert("è«‹è¼¸å…¥å°æ‰‹åå­—ï¼");
            matchData.info = {
                date: document.getElementById('setup-date').value,
                type: document.getElementById('setup-type').value,
                opponent: opp
            };
            document.getElementById('display-type').innerText = matchData.info.type;
            document.getElementById('display-opponent').innerText = matchData.info.opponent;
            showPage('tracker');
            renderActions();
        };

        // æ¸²æŸ“æŒ‰éˆ•
        function renderActions() {
            const grid = document.getElementById('on-court-actions');
            const actions = ['æ®ºçƒ', 'æ””ç¶²', 'é–‹çƒ', 'æ¥çƒ'];
            grid.innerHTML = '';
            actions.forEach(act => {
                grid.innerHTML += `
                    <div class="kuromi-card p-4 flex flex-col gap-2">
                        <p class="font-black text-center text-sm">${act}</p>
                        <button onclick="recordScore('A', '${act}', 1)" class="py-2 rounded-xl text-[10px] font-bold bg-[#FFD1E8]">ç›´æ¥å¾—åˆ† (+1)</button>
                        <button onclick="recordScore('A', '${act}', 2)" class="py-2 rounded-xl text-[10px] font-bold bg-[#E9D5FF]">æˆåŠŸéç¶² (ç¹¼çºŒ)</button>
                        <button onclick="recordScore('B', '${act}', 3)" class="py-2 rounded-xl text-[10px] font-bold bg-[#4C1D95] text-white">å¤±æ•— (å°æ‰‹+1)</button>
                    </div>
                `;
            });
        }

        // æ ¸å¿ƒè¨ˆåˆ†
        window.recordScore = (team, action, level) => {
            // ä¿å­˜æ­·å²ç”¨æ–¼æ’¤éŠ·
            historyStack.push(JSON.parse(JSON.stringify(matchData)));

            let detail = "";
            if (level === 1) { matchData.scoreA++; detail = "ç›´æ¥å¾—åˆ†"; }
            else if (level === 2) { detail = "æˆåŠŸéç¶²"; }
            else if (level === 3) { matchData.scoreB++; detail = "å¤±æ•—"; }

            // å¢åŠ è©³ç´°æ—¥èªŒ
            matchData.logs.unshift({
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                action: action,
                result: detail,
                score: `${matchData.scoreA}:${matchData.scoreB}`,
                isBench: matchData.isBench
            });

            updateDisplay();
            checkSetEnd();
        };

        function updateDisplay() {
            document.getElementById('score-a').innerText = matchData.scoreA;
            document.getElementById('score-b').innerText = matchData.scoreB;
            document.getElementById('sets-a').innerText = "Sets: " + matchData.setsA;
            document.getElementById('sets-b').innerText = "Sets: " + matchData.setsB;
        }

        function checkSetEnd() {
            const target = (matchData.setsA + matchData.setsB === 4) ? 15 : 25;
            if ((matchData.scoreA >= target || matchData.scoreB >= target) && Math.abs(matchData.scoreA - matchData.scoreB) >= 2) {
                document.getElementById('modal-score').innerText = `${matchData.scoreA} : ${matchData.scoreB}`;
                document.getElementById('modal-confirm').classList.remove('hidden');
            }
        }

        window.confirmSet = async () => {
            if (matchData.scoreA > matchData.scoreB) matchData.setsA++; else matchData.setsB++;
            
            // æ¯æ¬¡çµç®—å±€æ•¸ï¼Œè‡ªå‹•å­˜æª”å‚™ä»½ä¸€æ¬¡ (é¿å…ä¸è¦‹)
            saveMatch();

            if (matchData.setsA === 3 || matchData.setsB === 3) {
                alert("å…¨å ´æ¯”è³½çµæŸï¼æ•¸æ“šå·²åŒæ­¥è‡³é›²ç«¯ã€‚");
                showPage('setup');
                resetMatch();
            } else {
                matchData.scoreA = 0; matchData.scoreB = 0;
                updateDisplay();
                document.getElementById('modal-confirm').classList.add('hidden');
            }
        };

        window.undo = () => {
            if (historyStack.length > 0) {
                matchData = historyStack.pop();
                updateDisplay();
            }
        };

        window.toggleBench = () => {
            matchData.isBench = !matchData.isBench;
            const btn = document.getElementById('bench-toggle');
            const courtActions = document.getElementById('on-court-actions');
            const benchActions = document.getElementById('bench-actions');
            
            if (matchData.isBench) {
                btn.innerText = "ğŸ˜´ ç”·å‹å¾Œå‚™ä¸­";
                btn.style.backgroundColor = "#E2E8F0";
                courtActions.classList.add('hidden');
                benchActions.classList.remove('hidden');
            } else {
                btn.innerText = "ğŸ˜ˆ ç”·å‹åœ¨å ´ä¸Š";
                btn.style.backgroundColor = "#FFD1E8";
                courtActions.classList.remove('hidden');
                benchActions.classList.add('hidden');
            }
        };

        async function saveMatch() {
            if (!currentUser) return;
            try {
                await addDoc(collection(db, "matches"), {
                    userId: currentUser.uid,
                    info: matchData.info,
                    sets: `${matchData.setsA}:${matchData.setsB}`,
                    logs: matchData.logs,
                    memo: document.getElementById('match-memo').value,
                    createdAt: new Date()
                });
            } catch (e) { console.error("Save Error", e); }
        }

        window.viewHistory = async () => {
            if (!currentUser) return alert("è«‹å…ˆç™»å…¥ï¼");
            showPage('history');
            const listDiv = document.getElementById('history-list');
            listDiv.innerHTML = "è®€å–ä¸­...";
            
            const q = query(collection(db, "matches"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            
            listDiv.innerHTML = "";
            querySnapshot.forEach((doc) => {
                const m = doc.data();
                const dateStr = m.info.date || "ç„¡æ—¥æœŸ";
                listDiv.innerHTML += `
                    <div class="kuromi-card p-4 shadow-sm mb-4">
                        <div class="flex justify-between font-bold text-xs mb-2">
                            <span>${dateStr}</span>
                            <span class="text-purple-600">${m.info.type}</span>
                        </div>
                        <p class="text-lg">vs ${m.info.opponent} | <b>${m.sets}</b></p>
                        <details class="mt-2 text-[10px] opacity-60">
                            <summary>æŸ¥çœ‹æ¯ä¸€åˆ†è©³ç´°ç´€éŒ„</summary>
                            <div class="mt-2 space-y-1">
                                ${m.logs.slice(0, 10).map(l => `<div>${l.time} - ${l.action}${l.result} (${l.score})</div>`).join('')}
                                <p>... (åƒ…é¡¯ç¤ºæœ€æ–°10ç­†)</p>
                            </div>
                        </details>
                    </div>
                `;
            });
        };

        function resetMatch() {
            matchData = { scoreA: 0, scoreB: 0, setsA: 0, setsB: 0, isBench: false, logs: [], info: { date: "", type: "", opponent: "" } };
            historyStack = [];
            document.getElementById('modal-confirm').classList.add('hidden');
            updateDisplay();
        }

        window.closeModal = () => document.getElementById('modal-confirm').classList.add('hidden');

        // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
        document.getElementById('setup-date').valueAsDate = new Date();

    </script>
</body>
</html>
