<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kuromi æ’çƒå¤§å¸« Pro ğŸ˜ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * { touch-action: manipulation; -webkit-user-select: none; }
        body { font-family: 'Nunito', sans-serif; background-color: #F3E8FF; color: #4C1D95; margin: 0; padding: 0; overflow-x: hidden; }
        .page { display: none !important; min-height: 100vh; width: 100%; flex-direction: column; background-color: #F3E8FF; position: absolute; top: 0; left: 0; }
        .page.active { display: flex !important; }
        .kuromi-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); border-radius: 2.5rem; border: 1px solid rgba(255,255,255,0.5); }
        .btn-active:active { transform: scale(0.95); transition: 0.1s; }
        input, select { -webkit-user-select: text; border: 1px solid #E9D5FF; border-radius: 1rem; padding: 0.75rem; background: white; outline: none; width: 100%; font-size: 14px; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .set-tab-btn { padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: bold; background: white; border: 1px solid #D8B4FE; white-space: nowrap; }
        .set-tab-btn.active { background: #8B5CF6 !important; color: white !important; box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3); }
        .stats-grid { display: grid; grid-template-columns: 1.5fr 1fr 1fr 1.2fr; gap: 4px; text-align: center; font-size: 10px; margin-bottom: 10px; }
        .stats-header { font-weight: bold; opacity: 0.6; border-bottom: 1px solid #D8B4FE; padding-bottom: 4px; }
    </style>
</head>
<body>

    <div id="loading-screen" class="fixed inset-0 bg-[#F3E8FF] z-[5000] flex flex-col items-center justify-center">
        <div class="text-4xl animate-bounce mb-2">ğŸ˜ˆ</div>
    </div>

    <!-- 1. ç™»å…¥é é¢ -->
    <div id="page-login" class="page items-center justify-center p-6 text-center">
        <h1 class="text-5xl font-black mb-2 text-purple-800 tracking-tighter">KUROMI</h1>
        <p class="text-lg opacity-40 font-bold italic mb-12">Volleyball Tracker ğŸ˜ˆ</p>
        <button onclick="login()" class="kuromi-card px-10 py-5 font-black shadow-2xl flex items-center gap-4 btn-active bg-white text-lg border-2 border-purple-100">
            <img src="https://www.google.com/favicon.ico" class="w-6 h-6"> ä½¿ç”¨ Google ç™»å…¥
        </button>
    </div>

    <!-- 2. è¨­å®šé é¢ -->
    <div id="page-setup" class="page p-6">
        <div class="flex justify-between items-center mb-6 mt-4 px-2 text-[#8B5CF6]">
            <h1 class="text-3xl font-black">æ–°æ¯”è³½è¨­å®š</h1>
            <div class="flex flex-col items-end">
                <button onclick="viewHistory('setup')" class="text-sm opacity-60 font-black">ğŸ“š æ­·å²ç´€éŒ„</button>
                <button onclick="logout()" class="text-[10px] opacity-30 underline mt-1">ç™»å‡º</button>
            </div>
        </div>
        <div class="kuromi-card p-8 space-y-4 shadow-2xl">
            <div>
                <label class="text-xs font-bold opacity-40 ml-2 mb-1 block">æ¯”è³½æ—¥æœŸ</label>
                <input type="date" id="setup-date">
            </div>
            <div>
                <label class="text-xs font-bold opacity-40 ml-2 mb-1 block">è³½äº‹ç¨®é¡</label>
                <select id="setup-type">
                    <option value="ğŸ† è¯è³½">ğŸ† è¯è³½</option><option value="ğŸ“Š æ’ä½è³½">ğŸ“Š æ’ä½è³½</option><option value="ğŸ–ï¸ éŒ¦æ¨™è³½">ğŸ–ï¸ éŒ¦æ¨™è³½</option><option value="ğŸ æ™®é€šæ¯”è³½">ğŸ æ™®é€šæ¯”è³½</option>
                </select>
            </div>
            <div>
                <label class="text-xs font-bold opacity-40 ml-2 mb-1 block">è³½åˆ¶ (å‹åˆ©æ¢ä»¶)</label>
                <select id="setup-format">
                    <option value="3">äº”ç›¤ä¸‰å‹ (è´ 3 å±€å‹)</option>
                    <option value="2">ä¸‰ç›¤å…©å‹ (è´ 2 å±€å‹)</option>
                </select>
            </div>
            <div>
                <label class="text-xs font-bold opacity-40 ml-2 mb-1 block">å°æ‰‹åç¨±</label>
                <input type="text" id="setup-opponent" placeholder="è¼¸å…¥å°æ‰‹åå­—...">
            </div>
            <button onclick="startMatch()" class="w-full bg-[#8B5CF6] text-white py-5 rounded-[2.5rem] font-black text-xl btn-active shadow-lg mt-2">é–‹å§‹è¨˜éŒ„æ¯”è³½ï¼</button>
        </div>
        <div id="resume-section" class="hidden mt-6 text-center">
            <button onclick="resumeMatch()" class="text-[#8B5CF6] font-bold underline text-sm">å›å¾©ä¸Šä¸€å ´æœªå®Œæˆæ¯”è³½ ğŸ”™</button>
        </div>
    </div>

    <!-- 3. è¨ˆåˆ†é é¢ -->
    <div id="page-tracker" class="page p-4 flex flex-col overflow-hidden">
        <div class="flex justify-between items-center mb-4 px-2">
            <div id="display-info" class="text-[10px] font-bold opacity-40 uppercase"></div>
            <div class="flex gap-2">
                <button onclick="viewHistory('tracker')" class="bg-white/60 px-4 py-1 rounded-full text-[10px] font-bold shadow-sm">ç´€éŒ„</button>
                <button onclick="undo()" class="bg-white/60 px-4 py-1 rounded-full text-[10px] font-bold shadow-sm">æ’¤å›</button>
            </div>
        </div>

        <div class="kuromi-card p-6 shadow-lg text-center mb-4 border-2 border-white">
            <div class="flex justify-around items-center text-[#8B5CF6]">
                <div class="flex-1">
                    <p class="text-xs opacity-40 mb-1">æˆ‘æ–¹</p>
                    <h1 id="score-a" class="text-6xl font-black">0</h1>
                    <div id="sets-a" class="mt-1 text-xs font-black text-pink-500">Sets: 0</div>
                </div>
                <div class="text-3xl opacity-10 font-light">:</div>
                <div class="flex-1">
                    <p class="text-xs opacity-40 mb-1 text-gray-400">å°æ‰‹</p>
                    <h1 id="score-b" class="text-6xl font-black opacity-30 text-gray-400">0</h1>
                    <div id="sets-b" class="mt-1 text-xs font-black opacity-10 text-gray-400">Sets: 0</div>
                </div>
            </div>
        </div>

        <div class="flex justify-center mb-4">
            <button id="bench-toggle" onclick="toggleBench()" class="px-10 py-2 rounded-full font-black bg-[#FFD1E8] text-xs shadow-md btn-active">ğŸ˜ˆ ç”·å‹åœ¨å ´ä¸Š</button>
        </div>

        <div id="actions-container" class="flex-grow overflow-y-auto scroll-hide">
            <div id="on-court-actions" class="grid grid-cols-2 gap-3 mb-4"></div>
            <div id="on-court-general" class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="recordScore('A', 'éšŠå‹/å°æ‰‹å¤±èª¤', 1)" class="py-4 bg-[#A78BFA] text-white rounded-2xl font-black text-xs shadow-lg btn-active">æˆ‘æ–¹å¾—åˆ† (+1)</button>
                <button onclick="recordScore('B', 'å°æ‰‹å¼·æ”»/æˆ‘æ–¹å¤±èª¤', 3)" class="py-4 bg-[#94A3B8] text-white rounded-2xl font-black text-xs shadow-lg btn-active">å°æ‰‹å¾—åˆ† (+1)</button>
            </div>
        </div>

        <div id="bench-actions" class="hidden grid grid-cols-2 gap-4 h-48 mb-4">
            <button onclick="recordScore('A', 'éšŠå‹å¾—åˆ†', 1)" class="bg-[#A78BFA] text-white rounded-[2.5rem] font-black text-xl shadow-lg btn-active">æˆ‘æ–¹å¾—åˆ† (+1)</button>
            <button onclick="recordScore('B', 'å°æ‰‹å¾—åˆ†', 3)" class="bg-[#94A3B8] text-white rounded-[2.5rem] font-black text-xl shadow-lg btn-active">å°æ‰‹å¾—åˆ† (+1)</button>
        </div>

        <textarea id="match-memo" oninput="autoSaveLocal()" placeholder="å‚™è¨»..." class="w-full p-3 rounded-2xl bg-white/40 text-xs h-12 outline-none mt-2 shadow-inner"></textarea>
    </div>

    <!-- 4. æ­·å²ç´€éŒ„é é¢ -->
    <div id="page-history" class="page p-6" style="z-index: 1000; background-color: #F3E8FF;">
        <div class="flex items-center gap-4 mb-8 px-2">
            <button onclick="backFromHistory()" class="w-10 h-10 bg-white rounded-full shadow flex items-center justify-center font-bold btn-active">â†</button>
            <h2 class="text-2xl font-black text-purple-600">æ­·å²ç´€éŒ„</h2>
        </div>
        <div id="history-list" class="space-y-6 overflow-y-auto flex-grow pb-10 scroll-hide"></div>
    </div>

    <!-- çµç®—å½ˆçª— -->
    <div id="modal-confirm" class="hidden fixed inset-0 bg-black/75 backdrop-blur-sm flex items-center justify-center p-6 z-[6000]">
        <div class="bg-white rounded-[3rem] p-8 w-full max-w-sm text-center border-4 border-[#F3E8FF]">
            <h2 class="text-2xl font-black mb-2 text-[#8B5CF6]">æœ¬å±€çµæŸï¼Ÿ</h2>
            <p id="modal-score" class="text-xl font-bold opacity-30 mb-8">25 : 23</p>
            <button onclick="confirmSet()" class="w-full py-5 bg-[#8B5CF6] text-white rounded-full font-black text-lg shadow-xl mb-4 btn-active">ç¢ºå®šçµç®—æœ¬å±€</button>
            <button onclick="closeModal()" class="w-full py-4 bg-gray-100 rounded-full font-bold text-gray-400 btn-active">è¿”å›</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, setDoc, doc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCg4RX71wE7Wus4wqt-Gwj4lTBNREg4kRo",
            authDomain: "mykuromivolley.firebaseapp.com",
            projectId: "mykuromivolley",
            storageBucket: "mykuromivolley.firebasestorage.app",
            messagingSenderId: "739236472230",
            appId: "1:739236472230:web:30e594b0b641e491245b67"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });

        let currentUser = null;
        let matchDocId = null;
        let matchData = { scoreA: 0, scoreB: 0, setsA: 0, setsB: 0, isBench: false, logs: [], setsHistory: {}, info: { winTarget: 3 } };
        let historyStack = [];
        let historySource = 'setup';
        let matchesCache = {}; // ç”¨æ–¼æš«å­˜æ­·å²ç´€éŒ„æ•¸æ“š

        onAuthStateChanged(auth, (user) => {
            document.getElementById('loading-screen').classList.add('hidden');
            if (user) { currentUser = user; showPage('setup'); checkLocalSave(); } 
            else { showPage('login'); }
        });

        window.login = () => signInWithPopup(auth, provider).catch(e => console.error(e));
        window.logout = () => signOut(auth).then(() => { localStorage.removeItem('kuromi_match_temp'); location.reload(); });

        window.showPage = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            if (id === 'tracker') renderActions();
        };

        window.startMatch = () => {
            const opp = document.getElementById('setup-opponent').value;
            if (!opp) return alert("è¨˜å¾—å¡«å¯«å°æ‰‹åå­—ï¼");
            matchDocId = "match_" + Date.now();
            matchData.info = { date: document.getElementById('setup-date').value, type: document.getElementById('setup-type').value, winTarget: parseInt(document.getElementById('setup-format').value), opponent: opp, timestamp: Date.now() };
            document.getElementById('display-info').innerText = `${matchData.info.type} | ${matchData.info.opponent}`;
            matchData.scoreA = 0; matchData.scoreB = 0; matchData.setsA = 0; matchData.setsB = 0;
            matchData.logs = []; matchData.setsHistory = {};
            updateDisplay();
            showPage('tracker');
            autoSaveLocal();
        };

        window.recordScore = (team, action, level) => {
            historyStack.push(JSON.parse(JSON.stringify(matchData)));
            if (level === 1) matchData.scoreA++;
            if (level === 3) matchData.scoreB++;
            const resTxt = level === 1 ? "å¾—åˆ†(+1)" : (level === 2 ? "éç¶²" : "å¤±æ•—(å°æ‰‹+1)");
            matchData.logs.unshift({ time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), action, result: resTxt, score: `${matchData.scoreA}:${matchData.scoreB}`, level: level });
            updateDisplay();
            autoSaveLocal();
            checkSetEnd();
        };

        function checkSetEnd() {
            const target = (matchData.setsA + matchData.setsB === (matchData.info.winTarget * 2 - 2)) ? 15 : 25;
            if ((matchData.scoreA >= target && matchData.scoreA - matchData.scoreB >= 2) || (matchData.scoreB >= target && matchData.scoreB - matchData.scoreA >= 2)) {
                document.getElementById('modal-score').innerText = `${matchData.scoreA} : ${matchData.scoreB}`;
                document.getElementById('modal-confirm').classList.remove('hidden');
            }
        }

        window.confirmSet = async () => {
            const setNum = (matchData.setsA + matchData.setsB + 1).toString();
            const stats = {};
            ['æ®ºçƒ', 'æ””ç¶²', 'é–‹çƒ', 'æ¥çƒ'].forEach(act => {
                const actLogs = matchData.logs.filter(l => l.action === act);
                stats[act] = { 
                    success: actLogs.filter(l => l.level === 1 || l.level === 2).length, 
                    fail: actLogs.filter(l => l.level === 3).length 
                };
            });
            matchData.setsHistory[setNum] = { score: `${matchData.scoreA}:${matchData.scoreB}`, logs: [...matchData.logs], stats: stats };
            if (matchData.scoreA > matchData.scoreB) matchData.setsA++; else matchData.setsB++;
            
            await setDoc(doc(db, "matches", matchDocId), {
                userId: currentUser.uid, info: matchData.info, finalSets: `${matchData.setsA}:${matchData.setsB}`,
                setsHistory: matchData.setsHistory, memo: document.getElementById('match-memo').value, createdAt: new Date()
            });

            if (matchData.setsA === matchData.info.winTarget || matchData.setsB === matchData.info.winTarget) {
                alert("å…¨å ´çµæŸï¼ç´€éŒ„å·²åŒæ­¥ ğŸ˜ˆ");
                localStorage.removeItem('kuromi_match_temp');
                resetMatchVars();
                showPage('setup');
            } else {
                matchData.scoreA = 0; matchData.scoreB = 0; matchData.logs = [];
                updateDisplay();
                document.getElementById('modal-confirm').classList.add('hidden');
                autoSaveLocal();
            }
        };

        window.viewHistory = async (source) => {
            historySource = source;
            showPage('history');
            const list = document.getElementById('history-list');
            list.innerHTML = "<p class='text-center opacity-30 py-10'>å¬å–šæ•¸æ“šä¸­...</p>";
            try {
                const q = query(collection(db, "matches"), where("userId", "==", currentUser.uid));
                const snap = await getDocs(q);
                let sortedDocs = snap.docs.sort((a, b) => (b.data().createdAt?.seconds || 0) - (a.data().createdAt?.seconds || 0));
                list.innerHTML = sortedDocs.length === 0 ? "<p class='text-center py-10 opacity-30'>æœªæœ‰ç´€éŒ„</p>" : "";
                
                matchesCache = {}; // æ¸…ç©ºæš«å­˜
                sortedDocs.forEach(d => {
                    const m = d.data();
                    const mid = d.id;
                    matchesCache[mid] = m.setsHistory; // å­˜å…¥æš«å­˜
                    const sets = Object.keys(m.setsHistory || {}).sort((a,b) => a-b);
                    
                    list.innerHTML += `
                        <div class="kuromi-card p-6 shadow-md mb-4 bg-white border border-purple-50">
                            <div class="flex justify-between text-[10px] font-bold mb-2 opacity-40 uppercase">${m.info?.date || 'èˆŠç´€éŒ„'} | ${m.info?.type || ''}</div>
                            <p class="font-black text-lg mb-3 text-[#4C1D95]">vs ${m.info?.opponent || ''} <span class="text-[#8B5CF6] ml-2">${m.finalSets || ''}</span></p>
                            <div class="flex gap-2 mb-3 overflow-x-auto pb-2 scroll-hide">
                                ${sets.map(k => `<button onclick="showSetDetail('${mid}', '${k}')" class="set-tab-btn" id="btn-${mid}-${k}">ç¬¬ ${k} å±€</button>`).join('')}
                            </div>
                            <div id="det-${mid}" class="hidden text-[10px] bg-purple-50/50 p-4 rounded-3xl space-y-3 shadow-inner border border-purple-100"></div>
                            <p class="text-[10px] opacity-40 mt-3 italic">${m.memo || ""}</p>
                        </div>`;
                });
            } catch (e) { list.innerHTML = "è®€å–å¤±æ•—"; }
        };

        window.showSetDetail = (mid, k) => {
            const div = document.getElementById('det-'+mid);
            const setsData = matchesCache[mid]; // ç”±æš«å­˜è®€å–
            if (!setsData || !setsData[k]) return;
            const set = setsData[k];
            
            div.classList.remove('hidden');
            document.querySelectorAll(`[id^="btn-${mid}-"]`).forEach(b => b.classList.remove('active'));
            const activeBtn = document.getElementById(`btn-${mid}-${k}`);
            if(activeBtn) activeBtn.classList.add('active');
            
            let statsHtml = `<div class="stats-grid"><div class="stats-header">é …ç›®</div><div class="stats-header">æˆåŠŸ</div><div class="stats-header">å¤±æ•—</div><div class="stats-header">æˆåŠŸç‡</div>`;
            const actions = ['æ®ºçƒ', 'æ””ç¶²', 'é–‹çƒ', 'æ¥çƒ'];
            
            actions.forEach(action => {
                const val = (set.stats && set.stats[action]) ? set.stats[action] : { success: 0, fail: 0 };
                const total = val.success + val.fail;
                const rate = total === 0 ? "0%" : Math.round((val.success / total) * 100) + "%";
                statsHtml += `<div>${action}</div><div class="text-pink-500 font-bold">${val.success}</div><div>${val.fail}</div><div class="bg-white px-2 py-0.5 rounded-full font-black text-purple-600 border border-purple-100">${rate}</div>`;
            });
            statsHtml += `</div>`;
            
            const logsHtml = (set.logs || []).map(l => `<div class="flex justify-between border-b border-white/50 py-1 opacity-70"><span>${l.time} ${l.action} ${l.result}</span> <span class="font-bold">${l.score}</span></div>`).join('');
            
            div.innerHTML = `<p class="font-black text-[#8B5CF6] border-b border-purple-200 pb-2 mb-2 italic">è©²å±€æ¯”åˆ†: ${set.score}</p>` + statsHtml + `<div class="mt-4 space-y-1">` + logsHtml + `</div>`;
        };

        window.autoSaveLocal = () => localStorage.setItem('kuromi_match_temp', JSON.stringify({matchData, matchDocId}));
        window.resumeMatch = () => {
            const saved = JSON.parse(localStorage.getItem('kuromi_match_temp'));
            if (saved) { matchData = saved.matchData; matchDocId = saved.matchDocId; document.getElementById('match-memo').value = matchData.memo || ""; updateDisplay(); toggleBenchUI(); showPage('tracker'); }
        };
        function checkLocalSave() { if (localStorage.getItem('kuromi_match_temp')) document.getElementById('resume-section').classList.remove('hidden'); }
        function resetMatchVars() { matchData = { scoreA: 0, scoreB: 0, setsA: 0, setsB: 0, isBench: false, logs: [], setsHistory: {}, info: { winTarget: 3 } }; matchDocId = null; document.getElementById('match-memo').value = ""; updateDisplay(); document.getElementById('modal-confirm').classList.add('hidden'); }
        window.backFromHistory = () => showPage(historySource);
        window.undo = () => { if(historyStack.length > 0) { matchData = historyStack.pop(); updateDisplay(); autoSaveLocal(); } };
        window.closeModal = () => document.getElementById('modal-confirm').classList.add('hidden');
        window.toggleBench = () => { matchData.isBench = !matchData.isBench; toggleBenchUI(); autoSaveLocal(); };
        function updateDisplay() { document.getElementById('score-a').innerText = matchData.scoreA; document.getElementById('score-b').innerText = matchData.scoreB; document.getElementById('sets-a').innerText = "Sets: " + matchData.setsA; document.getElementById('sets-b').innerText = "Sets: " + matchData.setsB; }
        function toggleBenchUI() {
            const btn = document.getElementById('bench-toggle');
            btn.innerText = matchData.isBench ? "ğŸ˜´ ç”·å‹å¾Œå‚™ä¸­" : "ğŸ˜ˆ ç”·å‹åœ¨å ´ä¸Š";
            btn.style.backgroundColor = matchData.isBench ? "#E2E8F0" : "#FFD1E8";
            document.getElementById('on-court-actions').style.display = matchData.isBench ? 'none' : 'grid';
            document.getElementById('on-court-general').style.display = matchData.isBench ? 'none' : 'grid';
            document.getElementById('bench-actions').style.display = matchData.isBench ? 'grid' : 'none';
        }
        function renderActions() {
            const grid = document.getElementById('on-court-actions');
            grid.innerHTML = '';
            ['æ®ºçƒ', 'æ””ç¶²', 'é–‹çƒ', 'æ¥çƒ'].forEach(act => {
                grid.innerHTML += `<div class="kuromi-card p-4 flex flex-col gap-2 shadow-sm text-center border-2 border-white/50"><p class="font-black text-sm uppercase">${act}</p><button onclick="recordScore('A', '${act}', 1)" class="bg-[#FFD1E8] text-[10px] font-bold py-3 rounded-2xl btn-active shadow-sm">å¾—åˆ†(+1)</button><button onclick="recordScore('A', '${act}', 2)" class="bg-[#E9D5FF] text-[10px] font-bold py-3 rounded-2xl btn-active shadow-sm">éç¶²</button><button onclick="recordScore('B', '${act}', 3)" class="bg-[#4C1D95] text-white text-[10px] font-bold py-3 rounded-2xl btn-active shadow-sm">å¤±æ•—(å°æ‰‹+1)</button></div>`;
            });
        }
        document.getElementById('setup-date').valueAsDate = new Date();
    </script>
</body>
</html>
