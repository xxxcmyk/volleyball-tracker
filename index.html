<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kuromi æ’çƒå¤§å¸« Pro ğŸ˜ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* ç¦æ­¢ç¸®æ”¾èˆ‡ç³»çµ±å¹²æ“¾ */
        * { touch-action: manipulation; -webkit-user-select: none; }
        body { font-family: 'Nunito', sans-serif; background-color: #F3E8FF; color: #4C1D95; overflow-x: hidden; }
        .kuromi-card { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.4); border-radius: 2rem; }
        .btn-active:active { transform: scale(0.92); transition: 0.1s; }
        .hidden { display: none; }
        .action-btn { font-size: 11px; font-weight: 800; padding: 12px 4px; border-radius: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .set-tab-btn { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: bold; background: white; border: 1px solid #D8B4FE; transition: 0.2s; }
        .set-tab-btn.active { background: #8B5CF6 !important; color: white !important; box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3); }
        input, select { -webkit-user-select: text; }
    </style>
</head>
<body>

    <!-- è¼‰å…¥ä¸­é®ç½© -->
    <div id="loading" class="fixed inset-0 bg-[#F3E8FF] z-[200] flex flex-col items-center justify-center font-bold">
        <div class="mb-4 text-4xl animate-bounce">ğŸ˜ˆ</div>
        <p class="opacity-50">æ­£åœ¨åŒæ­¥ Google æ•¸æ“š...</p>
    </div>

    <!-- é é¢ 1: ç™»å…¥ -->
    <div id="page-login" class="hidden min-h-screen flex flex-col items-center justify-center p-6 text-center">
        <h1 class="text-4xl font-black mb-2">KUROMI</h1>
        <p class="text-lg opacity-60 mb-12">Volleyball Master Pro ğŸ˜ˆ</p>
        <button onclick="login()" class="kuromi-card px-8 py-4 font-bold shadow-xl flex items-center gap-3 btn-active">
            <img src="https://www.google.com/favicon.ico" class="w-5 h-5"> é»æ­¤ç™»å…¥ Google å¸³è™Ÿ
        </button>
        <p class="mt-6 text-[10px] opacity-30 px-10">æ•¸æ“šå°‡è‡ªå‹•å‚™ä»½è‡³æ‚¨çš„ Google Firebase é›²ç«¯</p>
    </div>

    <!-- é é¢ 2: è¨­å®š -->
    <div id="page-setup" class="hidden min-h-screen p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black text-[#8B5CF6]">æ–°æ¯”è³½è¨­å®š</h2>
            <button onclick="logout()" class="text-[10px] opacity-30 underline">ç™»å‡ºå¸³è™Ÿ</button>
        </div>
        <div class="kuromi-card p-6 space-y-4 shadow-lg mb-6">
            <div>
                <label class="text-[10px] font-bold opacity-40 ml-2">æ¯”è³½æ—¥æœŸ</label>
                <input type="date" id="setup-date" class="w-full p-3 rounded-2xl bg-white/50 border border-purple-200">
            </div>
            <div>
                <label class="text-[10px] font-bold opacity-40 ml-2">è³½äº‹ç¨®é¡</label>
                <select id="setup-type" class="w-full p-3 rounded-2xl bg-white/50 border border-purple-200">
                    <option>ğŸ† è¯è³½</option><option>ğŸ“Š æ’ä½è³½</option><option>ğŸ–ï¸ éŒ¦æ¨™è³½</option><option>ğŸ æ™®é€šæ¯”è³½</option>
                </select>
            </div>
            <div>
                <label class="text-[10px] font-bold opacity-40 ml-2">å°æ‰‹çƒéšŠåå­—</label>
                <input type="text" id="setup-opponent" placeholder="ä¾‹å¦‚: æŸæŸå¤§å­¸" class="w-full p-3 rounded-2xl bg-white/50 border border-purple-200">
            </div>
            <button onclick="startMatch()" class="w-full bg-[#8B5CF6] text-white py-4 rounded-[2rem] font-black text-lg btn-active shadow-lg">é–‹å§‹è¨ˆåˆ† ğŸ˜ˆ</button>
        </div>
        
        <button onclick="viewHistory('setup')" class="w-full py-4 kuromi-card font-bold border-2 border-white shadow-md text-purple-600">ğŸ“š æŸ¥çœ‹æ­·å²æ¯”è³½ç´€éŒ„</button>

        <div id="resume-section" class="hidden mt-8 p-6 border-2 border-dashed border-purple-300 rounded-[2rem] text-center bg-white/30">
            <p class="text-xs opacity-50 mb-3">åµæ¸¬åˆ°å…ˆå‰æœªå®Œæˆçš„æ¯”è³½...</p>
            <button onclick="resumeMatch()" class="text-[#8B5CF6] font-black underline decoration-2">å›å¾©æ•¸æ“šä¸¦ç¹¼çºŒæ¯”è³½ ğŸ”™</button>
        </div>
    </div>

    <!-- é é¢ 3: è¨ˆåˆ†ä¸»ä»‹é¢ -->
    <div id="page-tracker" class="hidden min-h-screen p-4 flex flex-col">
        <div class="flex justify-between items-center mb-4 px-2">
            <div class="text-[10px] font-bold opacity-50 bg-white/40 px-3 py-1 rounded-full">
                <span id="display-type"></span> | <span id="display-opponent"></span>
            </div>
            <div class="flex gap-2">
                <button onclick="viewHistory('tracker')" class="kuromi-card px-3 py-1 text-[10px] font-bold">ç´€éŒ„</button>
                <button onclick="undo()" class="kuromi-card px-3 py-1 text-[10px] font-bold">â†© è¿”å›</button>
            </div>
        </div>

        <!-- æ¯”åˆ†é¡¯ç¤º -->
        <div class="kuromi-card p-6 shadow-md text-center mb-4 border-2 border-white">
            <div class="flex justify-around items-center">
                <div class="flex-1">
                    <p class="text-[10px] opacity-40">æˆ‘æ–¹</p>
                    <h1 id="score-a" class="text-7xl font-black text-[#8B5CF6]">0</h1>
                    <div id="sets-a" class="mt-2 text-sm font-black text-pink-400">Sets: 0</div>
                </div>
                <div class="text-4xl opacity-10 font-light">:</div>
                <div class="flex-1">
                    <p class="text-[10px] opacity-40">å°æ‰‹</p>
                    <h1 id="score-b" class="text-7xl font-black opacity-30">0</h1>
                    <div id="sets-b" class="mt-2 text-sm font-black opacity-20">Sets: 0</div>
                </div>
            </div>
        </div>

        <!-- ç”·å‹ç‹€æ…‹ -->
        <div class="flex justify-center mb-4">
            <button id="bench-toggle" onclick="toggleBench()" class="px-10 py-2 rounded-full font-black shadow-md text-sm bg-[#FFD1E8] btn-active">ğŸ˜ˆ ç”·å‹åœ¨å ´ä¸Š</button>
        </div>

        <!-- ä¸‰å±¤æŒ‰éˆ•å€ -->
        <div id="on-court-actions" class="grid grid-cols-2 gap-3 mb-4 flex-grow overflow-y-auto pr-1"></div>

        <!-- å¾Œå‚™æŒ‰éˆ•å€ -->
        <div id="bench-actions" class="hidden grid grid-cols-2 gap-4 mb-4 h-48">
            <button onclick="recordScore('A', 'éšŠå‹å¾—åˆ†', 1)" class="bg-[#A78BFA] text-white rounded-[2.5rem] font-black text-xl shadow-lg btn-active">æˆ‘æ–¹å¾—åˆ†</button>
            <button onclick="recordScore('B', 'å°æ‰‹å¾—åˆ†', 3)" class="bg-[#94A3B8] text-white rounded-[2.5rem] font-black text-xl shadow-lg btn-active">å°æ‰‹å¾—åˆ†</button>
        </div>

        <textarea id="match-memo" oninput="autoSaveLocal()" placeholder="åœ¨æ­¤è¼¸å…¥æ¯”è³½å¿ƒå¾—æˆ–å‚™è¨»..." class="w-full p-4 rounded-2xl bg-white/40 text-sm h-16 outline-none mt-auto shadow-inner"></textarea>
    </div>

    <!-- é é¢ 4: æ­·å²ç´€éŒ„æ¸…å–®èˆ‡è©³æƒ… -->
    <div id="page-history" class="hidden min-h-screen p-6">
        <div class="flex items-center gap-4 mb-8">
            <button onclick="backFromHistory()" class="bg-white p-2 rounded-full shadow-sm text-lg">â†</button>
            <h2 class="text-2xl font-black">æ­·å²ç´€éŒ„ ğŸ“Š</h2>
        </div>
        <div id="history-list" class="space-y-6"></div>
    </div>

    <!-- çµç®—å½ˆçª— -->
    <div id="modal-confirm" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-6 z-[100]">
        <div class="bg-white rounded-[3rem] p-8 w-full max-w-sm text-center border-4 border-[#F3E8FF]">
            <h2 class="text-2xl font-black mb-2 text-[#8B5CF6]">æœ¬å±€çµæŸï¼Ÿ</h2>
            <p id="modal-score" class="text-xl font-bold opacity-40 mb-8">25 : 23</p>
            <button onclick="confirmSet()" class="w-full py-5 bg-[#8B5CF6] text-white rounded-full font-black text-lg shadow-xl mb-4 btn-active">ç¢ºå®šçµç®—æœ¬å±€</button>
            <button onclick="closeModal()" class="w-full py-4 bg-gray-100 rounded-full font-bold text-gray-400 btn-active">æŒ‰éŒ¯äº†ï¼Œè¿”å›</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, setDoc, doc, getDocs, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCg4RX71wE7Wus4wqt-Gwj4lTBNREg4kRo",
            authDomain: "mykuromivolley.firebaseapp.com",
            projectId: "mykuromivolley",
            storageBucket: "mykuromivolley.firebasestorage.app",
            messagingSenderId: "739236472230",
            appId: "1:739236472230:web:30e594b0b641e491245b67"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let matchDocId = null;
        let pageHistorySource = 'setup';
        let matchData = { scoreA: 0, scoreB: 0, setsA: 0, setsB: 0, isBench: false, logs: [], setsHistory: {}, info: {} };
        let historyStack = [];

        // --- ç™»å…¥ç‹€æ…‹ç›£æ§ (è‡ªå‹•æ¥å›ç™»å…¥) ---
        setPersistence(auth, browserLocalPersistence).then(() => {
            getRedirectResult(auth).catch(e => console.error("Login Error", e));
            onAuthStateChanged(auth, (user) => {
                document.getElementById('loading').classList.add('hidden');
                if (user) {
                    currentUser = user;
                    showPage('setup');
                    checkLocalSave();
                } else {
                    showPage('login');
                }
            });
        });

        window.login = () => signInWithRedirect(auth, provider);
        window.logout = () => { if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) signOut(auth); };

        window.showPage = (id) => {
            ['login', 'setup', 'tracker', 'history'].forEach(p => document.getElementById('page-' + p).classList.add('hidden'));
            document.getElementById('page-' + id).classList.remove('hidden');
        };

        // --- æ¯”è³½é‚è¼¯ ---
        window.startMatch = () => {
            const opp = document.getElementById('setup-opponent').value;
            if (!opp) return alert("ğŸ˜ˆ è¨˜å¾—å¡«å¯«å°æ‰‹çƒéšŠåå­—å–”ï¼");
            
            matchDocId = "match_" + Date.now();
            matchData.info = { 
                date: document.getElementById('setup-date').value, 
                type: document.getElementById('setup-type').value, 
                opponent: opp, 
                timestamp: Date.now() 
            };
            
            document.getElementById('display-type').innerText = matchData.info.type;
            document.getElementById('display-opponent').innerText = matchData.info.opponent;
            updateDisplay();
            showPage('tracker');
            renderActions();
            autoSaveLocal();
        };

        window.recordScore = (team, action, level) => {
            historyStack.push(JSON.parse(JSON.stringify(matchData)));
            const resTxt = level === 1 ? "å¾—åˆ†" : (level === 2 ? "æˆåŠŸ" : "å¤±æ•—");
            if (level === 1) matchData.scoreA++;
            if (level === 3) matchData.scoreB++;

            matchData.logs.unshift({ 
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}), 
                action, 
                result: resTxt, 
                score: `${matchData.scoreA}:${matchData.scoreB}`,
                isBench: matchData.isBench
            });

            updateDisplay();
            autoSaveLocal();
            checkSetEnd();
        };

        window.confirmSet = async () => {
            const setNum = (matchData.setsA + matchData.setsB + 1).toString();
            // å­˜å…¥é€™å±€çš„ç´€éŒ„
            matchData.setsHistory[setNum] = { score: `${matchData.scoreA}:${matchData.scoreB}`, logs: [...matchData.logs] };
            
            if (matchData.scoreA > matchData.scoreB) matchData.setsA++; else matchData.setsB++;
            
            await saveToCloud(); // çµç®—ç«‹å³é›²ç«¯å‚™ä»½

            if (matchData.setsA === 3 || matchData.setsB === 3) {
                alert("å…¨å ´æ¯”è³½çµæŸï¼æ‰€æœ‰æ•¸æ“šå·²åŒæ­¥è‡³é›²ç«¯ ğŸ˜ˆ");
                localStorage.removeItem('kuromi_match_temp');
                resetMatch();
                showPage('setup');
            } else {
                // é–‹æ–°å±€
                matchData.scoreA = 0; matchData.scoreB = 0; matchData.logs = [];
                updateDisplay();
                document.getElementById('modal-confirm').classList.add('hidden');
                autoSaveLocal();
            }
        };

        async function saveToCloud() {
            if (!currentUser || !matchDocId) return;
            try {
                await setDoc(doc(db, "matches", matchDocId), {
                    userId: currentUser.uid,
                    info: matchData.info,
                    finalSets: `${matchData.setsA}:${matchData.setsB}`,
                    setsHistory: matchData.setsHistory,
                    memo: document.getElementById('match-memo').value,
                    createdAt: new Date()
                });
            } catch (e) { console.error("Cloud Save Fail", e); }
        }

        // --- æ­·å²ç´€éŒ„æ¸²æŸ“ (æ”¯æŒåˆ†å±€æŸ¥çœ‹) ---
        window.viewHistory = async (source) => {
            pageHistorySource = source;
            showPage('history');
            const list = document.getElementById('history-list');
            list.innerHTML = "<div class='text-center py-10 opacity-30 animate-pulse font-bold'>æ­£åœ¨å¬å–šæ•¸æ“šç´€éŒ„... ğŸ˜ˆ</div>";
            
            try {
                const q = query(collection(db, "matches"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);
                list.innerHTML = "";
                
                if (snap.empty) list.innerHTML = "<p class='text-center py-20 opacity-30 italic'>ç›®å‰é‚„æ²’æœ‰æ¯”è³½ç´€éŒ„å–”</p>";

                snap.forEach(d => {
                    const m = d.data();
                    const mid = d.id;
                    const sets = Object.keys(m.setsHistory).sort();
                    window["hData_" + mid] = m.setsHistory;

                    list.innerHTML += `
                        <div class="kuromi-card p-6 mb-4 shadow-sm border-2 border-white">
                            <div class="flex justify-between text-[10px] font-bold mb-2 opacity-50">
                                <span>${m.info.date}</span><span>${m.info.type}</span>
                            </div>
                            <p class="font-black text-xl mb-3">vs ${m.info.opponent} <span class="text-[#8B5CF6] ml-2">${m.finalSets}</span></p>
                            <div class="flex gap-2 mb-4 overflow-x-auto py-1 scroll-hide">
                                ${sets.map(k => `<button onclick="showSetDetail('${mid}', '${k}')" class="set-tab-btn" id="btn-${mid}-${k}">ç¬¬ ${k} å±€</button>`).join('')}
                            </div>
                            <div id="det-${mid}" class="hidden text-[10px] bg-white/50 p-4 rounded-2xl max-h-60 overflow-y-auto shadow-inner space-y-1"></div>
                            <p class="text-[10px] opacity-40 mt-3 italic">${m.memo || ""}</p>
                        </div>`;
                });
            } catch(e) { list.innerHTML = "è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·š"; }
        };

        window.showSetDetail = (mid, k) => {
            const div = document.getElementById('det-'+mid);
            const data = window["hData_"+mid][k];
            div.classList.remove('hidden');
            document.querySelectorAll(`[id^="btn-${mid}-"]`).forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${mid}-${k}`).classList.add('active');
            
            div.innerHTML = `<p class="font-black text-purple-600 border-b border-purple-200 pb-2 mb-2">æœ€çµ‚æ¯”åˆ†: ${data.score}</p>` + 
                data.logs.map(l => `<div class="flex justify-between border-b border-white/40 py-1"><span>${l.time} ${l.action}${l.result}</span> <span class="opacity-40 font-bold">${l.score}</span></div>`).join('');
        };

        // --- åŸºç¤å·¥å…· ---
        window.autoSaveLocal = () => localStorage.setItem('kuromi_match_temp', JSON.stringify({matchData, matchDocId}));
        
        window.resumeMatch = () => {
            const saved = JSON.parse(localStorage.getItem('kuromi_match_temp'));
            if (saved) { 
                matchData = saved.matchData; 
                matchDocId = saved.matchDocId; 
                document.getElementById('match-memo').value = matchData.memo || ""; 
                document.getElementById('display-type').innerText = matchData.info.type;
                document.getElementById('display-opponent').innerText = matchData.info.opponent;
                updateDisplay(); 
                toggleBenchUI(); 
                showPage('tracker'); 
                renderActions(); 
            }
        };

        function checkLocalSave() { 
            if (localStorage.getItem('kuromi_match_temp')) document.getElementById('resume-section').classList.remove('hidden'); 
            else document.getElementById('resume-section').classList.add('hidden');
        }

        window.backFromHistory = () => showPage(pageHistorySource);
        
        window.undo = () => { 
            if(historyStack.length > 0) { 
                matchData = historyStack.pop(); 
                updateDisplay(); 
                autoSaveLocal(); 
            } else {
                alert("æ²’æœ‰å‹•ä½œå¯ä»¥æ’¤å›äº†å–”ï¼");
            }
        };

        window.closeModal = () => document.getElementById('modal-confirm').classList.add('hidden');

        window.toggleBench = () => { matchData.isBench = !matchData.isBench; toggleBenchUI(); autoSaveLocal(); };

        function updateDisplay() { 
            document.getElementById('score-a').innerText = matchData.scoreA; 
            document.getElementById('score-b').innerText = matchData.scoreB; 
            document.getElementById('sets-a').innerText = "Sets: " + matchData.setsA; 
            document.getElementById('sets-b').innerText = "Sets: " + matchData.setsB; 
        }

        function toggleBenchUI() {
            const btn = document.getElementById('bench-toggle');
            if (matchData.isBench) { 
                btn.innerText = "ğŸ˜´ ç”·å‹å¾Œå‚™ä¸­"; btn.style.backgroundColor = "#E2E8F0"; 
                document.getElementById('on-court-actions').classList.add('hidden'); 
                document.getElementById('bench-actions').classList.remove('hidden'); 
            } else { 
                btn.innerText = "ğŸ˜ˆ ç”·å‹åœ¨å ´ä¸Š"; btn.style.backgroundColor = "#FFD1E8"; 
                document.getElementById('on-court-actions').classList.remove('hidden'); 
                document.getElementById('bench-actions').classList.add('hidden'); 
            }
        }

        function renderActions() {
            const grid = document.getElementById('on-court-actions');
            grid.innerHTML = '';
            ['æ®ºçƒ', 'æ””ç¶²', 'é–‹çƒ', 'æ¥çƒ'].forEach(act => {
                grid.innerHTML += `
                    <div class="kuromi-card p-3 flex flex-col gap-2 shadow-sm border border-white">
                        <p class="font-black text-center text-xs text-purple-800">${act}</p>
                        <button onclick="recordScore('A', '${act}', 1)" class="action-btn bg-[#FFD1E8]">å¾—åˆ†(+1)</button>
                        <button onclick="recordScore('A', '${act}', 2)" class="action-btn bg-[#E9D5FF] text-purple-700">éç¶²(ç¹¼çºŒ)</button>
                        <button onclick="recordScore('B', '${act}', 3)" class="action-btn bg-[#4C1D95] text-white">å¤±æ•—(å°æ‰‹+1)</button>
                    </div>`;
            });
        }

        function resetMatch() { 
            matchData = { scoreA: 0, scoreB: 0, setsA: 0, setsB: 0, isBench: false, logs: [], setsHistory: {}, info: {} }; 
            matchDocId = null; 
            updateDisplay(); 
            document.getElementById('modal-confirm').classList.add('hidden'); 
            checkLocalSave();
        }

        function checkSetEnd() { 
            const target = (matchData.setsA + matchData.setsB === 4) ? 15 : 25; 
            if ((matchData.scoreA >= target || matchData.scoreB >= target) && Math.abs(matchData.scoreA - matchData.scoreB) >= 2) { 
                document.getElementById('modal-score').innerText = `${matchData.scoreA} : ${matchData.scoreB}`; 
                document.getElementById('modal-confirm').classList.remove('hidden'); 
            } 
        }

        document.getElementById('setup-date').valueAsDate = new Date();
    </script>
</body>
</html>
