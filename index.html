<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuromi æ’çƒå¤§å¸«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK (é€™è®“ App èƒ½é€£ä¸Šé›²ç«¯) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”¥ é€™è£¡æ›æˆå¦³å‰›æ‰åœ¨ Firebase è¤‡è£½çš„é‚£æ®µ Config ğŸ”¥
        const firebaseConfig = {
            apiKey: "ä½ çš„APIKEY",
            authDomain: "ä½ çš„åŸŸå",
            projectId: "ä½ çš„å°ˆæ¡ˆID",
            storageBucket: "ä½ çš„å„²å­˜ç©ºé–“",
            messagingSenderId: "ä½ çš„ç™¼é€ID",
            appId: "ä½ çš„APPID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- å…¨åŸŸè®Šæ•¸ ---
        let user = null;
        let currentMatch = null;
        let matchLogs = [];
        let scoreA = 0, scoreB = 0, setsA = 0, setsB = 0;
        let isBench = false;

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šGoogle ç™»å…¥ ---
        window.login = async () => {
            const result = await signInWithPopup(auth, provider);
            user = result.user;
            showPage('setup-page');
        };

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šé–‹å§‹æ¯”è³½ ---
        window.startMatch = async () => {
            const date = document.getElementById('matchDate').value;
            const type = document.getElementById('matchType').value;
            const opponent = document.getElementById('opponent').value;
            
            if(!opponent) return alert("è«‹è¼¸å…¥å°æ‰‹åå­—ï¼");

            currentMatch = { date, type, opponent, owner: user.uid, startTime: serverTimestamp() };
            showPage('tracker-page');
            updateUI();
        };

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šè¨ˆåˆ†é‚è¼¯ (ä¸‰å±¤æŒ‰éˆ•) ---
        window.recordAction = async (action, result) => {
            // result: 1 = ç›´æ¥å¾—åˆ†, 2 = æˆåŠŸéç¶², 3 = å¤±æ•—
            let logText = `[${action}] `;
            
            if (result === 1) { 
                scoreA++; logText += "ç›´æ¥å¾—åˆ†ï¼(+1)"; 
            } else if (result === 3) { 
                scoreB++; logText += "å¤±æ•— (å°æ‰‹+1)"; 
            } else { 
                logText += "æˆåŠŸéç¶² (æ¯”åˆ†ä¸è®Š)"; 
            }

            // å„²å­˜åˆ°é›²ç«¯ç´€éŒ„ (æ¯ä¸€åˆ†éƒ½å­˜)
            const logEntry = {
                matchId: "", // å¾ŒçºŒè£œä¸Š
                timestamp: new Date().toLocaleTimeString(),
                action: action,
                result: result,
                score: `${scoreA}:${scoreB}`,
                isBench: isBench
            };
            matchLogs.unshift(logEntry); // æ”¾åœ¨ç´€éŒ„è¡¨æœ€ä¸Šé¢
            
            checkSetEnd();
            updateUI();
        };

        // --- å„²å­˜æ¯”è³½åˆ° Firebase ---
        window.saveMatchToCloud = async () => {
            await addDoc(collection(db, "matches"), {
                ...currentMatch,
                finalScore: `${setsA}:${setsB}`,
                logs: matchLogs
            });
            alert("æ•¸æ“šå·²åŒæ­¥è‡³ Google é›²ç«¯ï¼");
            showPage('setup-page');
        };

        // (å…¶ä»– UI åˆ‡æ›é‚è¼¯...)
        // ... æ­¤è™•ç°¡ç•¥ï¼Œå®Œæ•´ä»£ç¢¼å¯æ”¾åœ¨ GitHub ä¸Š ...
    </script>
    <style>
        .kuromi-bg { background-color: #F3E8FF; }
        .btn-pink { background-color: #FFD1E8; } /* ç›´æ¥å¾—åˆ† */
        .btn-purple { background-color: #E9D5FF; } /* æˆåŠŸéç¶² */
        .btn-dark { background-color: #4C1D95; color: white; } /* å¤±æ•— */
    </style>
</head>
<body class="kuromi-bg text-[#4C1D95]">
    <!-- 1. ç™»å…¥é  -->
    <div id="login-page" class="flex flex-col items-center justify-center min-h-screen">
        <h1 class="text-3xl font-bold mb-8">Kuromi æ’çƒæ•¸æ“šåº« ğŸ˜ˆ</h1>
        <button onclick="login()" class="bg-white px-8 py-3 rounded-full shadow-md font-bold">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</button>
    </div>

    <!-- 2. åˆå§‹åŒ–é é¢ -->
    <div id="setup-page" class="hidden p-6">
        <h2 class="text-xl font-bold mb-4">å»ºç«‹æ–°æ¯”è³½</h2>
        <div class="bg-white/60 p-6 rounded-3xl space-y-4">
            <div>
                <label class="block text-sm opacity-60">æ¯”è³½æ—¥æœŸ</label>
                <input type="date" id="matchDate" class="w-full bg-transparent border-b border-purple-300 py-2">
            </div>
            <div>
                <label class="block text-sm opacity-60">è³½äº‹ç¨®é¡</label>
                <select id="matchType" class="w-full bg-transparent border-b border-purple-300 py-2">
                    <option>è¯è³½</option><option>æ’ä½è³½</option><option>éŒ¦æ¨™è³½</option><option>æ™®é€šæ¯”è³½</option>
                </select>
            </div>
            <div>
                <label class="block text-sm opacity-60">å°æ‰‹åç¨±</label>
                <input type="text" id="opponent" placeholder="è¼¸å…¥å°æ‰‹çƒéšŠ..." class="w-full bg-transparent border-b border-purple-300 py-2">
            </div>
            <button onclick="startMatch()" class="w-full bg-purple-500 text-white py-4 rounded-2xl font-bold shadow-lg mt-4">é–‹å§‹è¨˜éŒ„æ¯”è³½</button>
        </div>
        <button onclick="viewHistory()" class="w-full mt-4 text-sm opacity-50 underline">æŸ¥çœ‹æ­·å²æ•¸æ“š</button>
    </div>

    <!-- 3. è¨ˆåˆ†è¿½è¹¤é  (ç•¥ï¼Œçµæ§‹åŒä¸Šä¸€å€‹ç‰ˆæœ¬ä½†å¢åŠ è©³ç´°æ—¥èªŒé¡¯ç¤º) -->
</body>
</html>
